# .github/workflows/business-deploy.yml
name: Business Service Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'services/business/**'
      - 'pyproject.toml'
      - 'poetry.lock'
      - '.github/workflows/business-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'services/business/**'

env:
  SERVICE_NAME: business

jobs:
  # í…ŒìŠ¤íŠ¸ ë‹¨ê³„
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --without dev --no-root

      - name: Run tests
        run: |
          poetry run pytest services/business/ -v || echo "No tests found, skipping..."

      - name: Build test
        run: |
          cd services/business/compose
          BUILD_TARGET=prod docker compose -f docker-compose.yml build

  # ë°°í¬ ë‹¨ê³„
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to OCI server
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            
            PROJECT_DIR="/opt/Pilot_Project"
            SERVICE_DIR="$PROJECT_DIR/services/business"
            COMPOSE_DIR="$SERVICE_DIR/compose"
            CONFIG_DIR="$PROJECT_DIR/config"

            echo "ğŸš€ Starting deployment..."

            # 1ï¸âƒ£ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
            sudo mkdir -p $SERVICE_DIR $CONFIG_DIR
            sudo chown -R ubuntu:ubuntu $PROJECT_DIR

            # 2ï¸âƒ£ Git ì—…ë°ì´íŠ¸
            cd $PROJECT_DIR
            if [ ! -d ".git" ]; then
                git init
                git remote add pilot ${{ secrets.PILOT_REPO_URL }}
            fi
            
            # ê¸°ì¡´ remote URL ì—…ë°ì´íŠ¸
            git remote set-url pilot ${{ secrets.PILOT_REPO_URL }} || true
            git fetch pilot main
            git reset --hard pilot/main

            # 3ï¸âƒ£ í™˜ê²½íŒŒì¼ ìƒì„± 
            umask 077  # íŒŒì¼ ê¶Œí•œì„ 600ìœ¼ë¡œ ì„¤ì •
            echo "${{ secrets.BUSINESS_MAIN_ENV }}" > $CONFIG_DIR/main.env
            echo "${{ secrets.SSH_TUNNEL_KEY }}" > $CONFIG_DIR/ssh_tunnel.pem
            echo "${{ secrets.JWT_PRIVATE_KEY }}" > $CONFIG_DIR/private_key.pem
            echo "${{ secrets.JWT_PUBLIC_KEY }}" > $CONFIG_DIR/public_key.pem
            echo "${{ secrets.REDIS_CONF_TEMPLATE }}" > $CONFIG_DIR/redis.conf.template  # ë¯¸ì‚¬ìš©(envsubst í™˜ê²½ë³€ìˆ˜ ì ìš© ë¶ˆì•ˆì •)


            chmod 600 $CONFIG_DIR/main.env
            chmod 600 $CONFIG_DIR/ssh_tunnel.pem
            chmod 600 $CONFIG_DIR/private_key.pem
            chmod 600 $CONFIG_DIR/public_key.pem
            chmod 600 $CONFIG_DIR/redis.conf.template

            # UID/GID ìë™ ê°ì§€ ë° ì„¤ì •
            CURRENT_UID=$(id -u)
            CURRENT_GID=$(id -g)
            echo "DOCKER_UID=$CURRENT_UID" >> $CONFIG_DIR/main.env
            echo "DOCKER_GID=$CURRENT_GID" >> $CONFIG_DIR/main.env

            # í™˜ê²½ë³€ìˆ˜ë¥¼ í˜„ì¬ ì‰˜ì—ë„ ë¡œë“œ
            export DOCKER_UID=$CURRENT_UID
            export DOCKER_GID=$CURRENT_GID

            ENV_FILE="$CONFIG_DIR/main.env"

            # 4ï¸âƒ£ ê¸°ì¡´ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ë° graceful shutdown
            cd $COMPOSE_DIR
            if sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml ps --services --filter "status=running" | grep -q .; then
                echo "ğŸ“‹ Stopping existing services..."
                sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml down --timeout 30
            fi

            # 5ï¸âƒ£ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
            echo "ğŸ”¨ Building images..."
            BUILD_TARGET=prod ENVIRONMENT=prod sudo -E docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache

            echo "ğŸš¢ Starting services..."
            BUILD_TARGET=prod ENVIRONMENT=prod sudo docker compose --env-file $ENV_FILE -f docker-compose.yml -f docker-compose.prod.yml up -d

            # 6ï¸âƒ£ Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ë¡œë“œ
            echo "ğŸ”„ Reloading nginx..."
            if sudo nginx -t; then
                sudo systemctl reload nginx
                echo "âœ… Nginx reloaded successfully"
            else
                echo "âŒ Nginx configuration test failed"
                exit 1
            fi

            # 7ï¸âƒ£ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up unused images..."
            sudo docker image prune -f

            echo "ğŸ‰ Deployment completed successfully!"
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi