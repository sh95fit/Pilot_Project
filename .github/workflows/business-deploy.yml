# .github/workflows/business-deploy.yml
name: Business Service Deploy

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'services/business/**'  # business 서비스 관련 변경 감지
      - 'config/**'             # 환경파일 변경 감지 가능

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 소스코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v3

      # 2️⃣ SSH 설정 (OCI 서버 접속용)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3️⃣ prod 배포
      - name: Deploy business service
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} '
            PROJECT_DIR="/opt/Pilot_Project"
            SERVICE_DIR="$PROJECT_DIR/services/business"
            CONFIG_DIR="$PROJECT_DIR/config"

            # 1️⃣ 디렉토리 생성 및 권한 설정
            sudo mkdir -p $SERVICE_DIR/compose
            sudo mkdir -p $CONFIG_DIR
            sudo chown -R ubuntu:ubuntu $PROJECT_DIR

            # 2️⃣ Git 초기화 및 최신화
            cd $PROJECT_DIR
            if [ ! -d ".git" ]; then
                git init
                git remote add pilot ${{ secrets.PILOT_REPO_URL }}
            fi
            git fetch pilot main
            git reset --hard pilot/main

            # 3️⃣ 환경파일 생성
            echo "${{ secrets.BUSINESS_MAIN_ENV }}" | sudo tee $CONFIG_DIR/main.env > /dev/null

            # 4️⃣ 기존 컨테이너 종료 (존재하는 경우만)
            if [ "$(sudo docker ps -q -f name=business)" ]; then
                sudo docker-compose -f $SERVICE_DIR/compose/docker-compose.yml -f $SERVICE_DIR/compose/docker-compose.prod.yml down
            fi

            # 5️⃣ 새 컨테이너 빌드 및 실행
            sudo docker-compose -f $SERVICE_DIR/compose/docker-compose.yml -f $SERVICE_DIR/compose/docker-compose.prod.yml up -d --build

            # 6️⃣ Nginx 재시작
            sudo systemctl reload nginx
          '
