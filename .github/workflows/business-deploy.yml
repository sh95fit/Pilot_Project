name: Business Service Deploy

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'services/business/**'      # business 서비스 관련 변경만 감지
      - 'config/**'                 # 환경파일 변경 감지 가능

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 소스코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v3

      # 2️⃣ SSH 설정 (OCI 서버 접속용)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3️⃣ prod 배포
      - name: Deploy business service
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} '
          # 필요한 디렉토리 생성 (없으면 생성) 및 권한 설정
          sudo mkdir -p /opt/Pilot_Project/services/business/compose
          sudo mkdir -p /opt/Pilot_Project/config
          sudo chown -R ubuntu:ubuntu /opt/Pilot_Project

          # 작업 디렉토리 이동
          cd /opt/Pilot_Project/services/business/compose

          # GitHub Secrets로 prod 환경변수 파일 생성
          echo "${{ secrets.BUSINESS_MAIN_ENV }}" | sudo tee ../../config/main.env > /dev/null

          # 기존 컨테이너 종료
          sudo docker-compose -f docker-compose.yml -f docker-compose.prod.yml down

          # 새 컨테이너 빌드 및 실행
          sudo docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
          '
